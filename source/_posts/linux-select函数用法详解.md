---
title: linux select函数用法详解
date: 2019-07-06 20:31:59
tags: linux
categories: linux
---
## linux select函数用法详解

1. 简介

   在程序进行工作时，有可能会发生阻塞。所谓阻塞，顾名思义，就是进程或是线程执行到这些函数时必须等待某个事件的发生，如果事件没有发生，进程或线程就被阻塞，函数不能立即返回，例如connect、 accept、recv这样的函数。而使用select就可以完成非阻塞方式工作的程序，而非阻塞方式就是进程或线程执行此函数时不必非要等待事件的发生，一旦执行肯定返回，以返回值的不同来反映函数的执行情况，如果事件发生则与阻塞方式相同，若事件没有发生则返回一个代码来告知事件未发生，而进程或线程继续执行，所以效率较高，它能够监视我们需要监视的文件描述符的变化情况——读写或是异常。

   <!-- more -->

2. 头文件

   ```c
   #include <sys/select.h>
   ```

3. 函数原型

   ```c
   int select(int nfds, fd_set *readfds, fd_set *writefds,fd_set *exceptfds, struct timeval *timeout);
   ```

4. 函数说明

   `select()`可以用来等待文件描述符的状态的改变。传递给`select()`的参数会告诉内核:

   + 需要关注的文件描述符的。
   + 需要对一个文件描述符读或者写，还是关注这个文件描述符是否发生异常。
   + 需要等待的时间。

   在`select()`返回时，内核则会告诉我们以下信息：

   + 对于我们的要求已经做好准备的描述符的个数。
   + 对于三种条件（读，写，异常）那些描述符已经做好准备。

5. 参数说明

   + **nfds:**

     其值为所有文件描述符中的最大值加1。

   + **fd_set:**

     可以理解成一个集合，其中的元素是文件描述符。fd_set类型变量每一位代表了一个描述符。我们也可以认为它只是一个由很多二进制位构成的数组。

     系统提供了4个宏对描述符集进行操作：

     ```c
     void FD_SET(int fd, fd_set *set);//添加文件描述符到fd_set集合中
     void FD_CLR(int fd, fd_set *set); //从fd_set集合中删除文件描述符
     int  FD_ISSET(int fd, fd_set *set);//判断文件描述符是否在fd_set中
     void FD_ZERO(fd_set *set);//清空fd_set集合
     ```

   + **readfds：**

     `fd_set *readfds`是指向`fd_set`结构的指针，这个集合中应该包括文件描述符，我们是要监视这些文件描述符的读变化的，即我们关心是否可以从这些文件中读取数据了，如果这个集合中有一个文件可读，`select()`就会返回一个大于0的值，表示有文件可读；如果没有可读的文件，则根据timeout参数再判断是否超时，若超出timeout的时间，`select()`返回0，若发生错误返回负值。可以传入`NULL`值，表示不关心任何文件的读变化。

   + **writefds:**

     `fd_set *writefds`是指向`fd_set`结构的指针，这个集合中应该包括文件描述符，我们是要监视这些文件描述符的写变化的，即我们关心是否可以向这些文件中写入数据了，如果这个集合中有一个文件可写，`select()`就会返回一个大于0的值，表示有文件可写，如果没有可写的文件，则根据timeout参数再判断是否超时，若超出timeout的时间，`select`(返回0，若发生错误返回负值。可以传入`NULL`值，表示不关心任何文件的写变化。

   + **exceptfds:**

     `fd_set *errorfds`同上面两个参数，用来监视文件错误异常文件。

   + **timeout:**

     `struct timeval* timeout`指定了`select()`等待文件描述符做好准备的时间。

     `timeval`结构体定义如下

     ```c
     struct timeval {
         long tv_sec;   /*秒 */
         long tv_usec;  /*微秒 */   
     }
     ```

     有三种情况:

     + `timeout == NULL`

       等待无限长的时间。等待可以被一个信号中断。当有一个描述符做好准备或者是捕获到一个信号时函数会返回。如果捕获到一个信号， `select()`函数将返回 -1,并将变量 errno设为 EINTR。

     + `timeout->tv_sec == 0 && timeout->tv_usec == 0`

       不等待，直接返回。加入描述符集的描述符都会被测试，并且返回满足要求的描述符的个数。这种方法通过轮询，无阻塞地获得了多个文件描述符状态。

     + `timeout->tv_sec != 0 || timeout->tv_usec != 0`

       等待指定的时间，当有描述符符合条件或者超过超时时间的话，函数返回。对于这种情况，等待也会被信号所中断。

6. 返回值

   成功则返回集合中已经就绪的描述符的数量，超时则返回为0，发生错误则返回-1并设置errno。